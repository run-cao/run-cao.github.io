(window.webpackJsonp=window.webpackJsonp||[]).push([[288],{760:function(s,a,t){"use strict";t.r(a);var e=t(62),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mybatis-的内置缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mybatis-的内置缓存"}},[s._v("#")]),s._v(" Mybatis 的内置缓存")]),s._v(" "),t("h2",{attrs:{id:"_1-mybatis-一级缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-mybatis-一级缓存"}},[s._v("#")]),s._v(" 1. Mybatis 一级缓存")]),s._v(" "),t("h3",{attrs:{id:"概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),t("p",[s._v("MyBatis 提供了查询缓存来缓存数据，从而达到提高查询新能的要求。MyBatis 的缓存分为一级缓存和二级缓存。")]),s._v(" "),t("p",[s._v("MyBatis 的一级缓存是 SqlSession 级别的缓存（"),t("small",[s._v("在操作数据库时需要构造 SqlSession 对象")]),s._v("），每个 SqlSession 对象中都有一个 HashMap 对象用于缓存数据，不同的 SqlSession 之间缓存的数据互不影响。")]),s._v(" "),t("blockquote",[t("p",[s._v("提前说明一下，当 mybatis 与 spring 整合后，"),t("strong",[s._v("如果没有事务，一级缓存是失效的！")])]),s._v(" "),t("p",[s._v("原因就是两者结合后，sqlsession 如果发现当前没有事务，那么每执行一个 mapper 方法之后，sqlsession 就被关闭了（ "),t("code",[s._v("session.close()")]),s._v(" ）。")]),s._v(" "),t("p",[s._v("所以记得给 Service 的方法的脑袋上面加 "),t("strong",[s._v("@Transactional")]),s._v(" 。")])]),s._v(" "),t("p",[s._v("在参数和 SQL 完全相同的情况下，使用同一个 SqlSession 对象调用同一个 Mapper 方法，往往只执行一次 SQL 语句。因为如果没有声明需要刷新缓存并且缓存没有超时，SqlSession 都只会取出当前缓存的数据"),t("small",[s._v("，而不是执行 SQL 语句")]),s._v("。")]),s._v(" "),t("p",[s._v("如果 SqlSession 执行了 DML 操作，并提交数据库，Mybatis 会清空 SqlSession 中的一级缓存，这样做的目的是保证缓存中存储的数据是最新的，避免出现脏读现象。")]),s._v(" "),t("h3",{attrs:{id:"刷新缓存的时机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#刷新缓存的时机"}},[s._v("#")]),s._v(" 刷新缓存的时机")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("如果 SqlSession 调用了 "),t("em",[t("strong",[s._v("close")])]),s._v(" 方法，则一级缓存不可用/销毁。")])]),s._v(" "),t("li",[t("p",[s._v("如果 SqlSession 调用了 "),t("em",[t("strong",[s._v("clearCache")])]),s._v(" 方法，则一级缓存中缓存的数据被清空。")])]),s._v(" "),t("li",[t("p",[s._v("如果 SqlSession 执行了一个 DML 操作，则一级缓存中缓存的数据被清空。")])])]),s._v(" "),t("h2",{attrs:{id:"_2-mybatis-二级缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-mybatis-二级缓存"}},[s._v("#")]),s._v(" 2. Mybatis 二级缓存")]),s._v(" "),t("p",[s._v("二级缓存是 Mapper 级别"),t("small",[s._v("（也叫 namespace 级别）")]),s._v("的缓存，同样使用 HashMap 进行数据存储。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("二级缓存是以 namespace 为单位的，不同的 namespace 下的操作相互隔离。")])]),s._v(" "),t("li",[t("p",[s._v("增删改操作会清空 namespace 下的全部缓存。")])])]),s._v(" "),t("p",[s._v("如果开启了二级缓存，那么在关闭 sqlsession 后，会把该 sqlsession 一级缓存中的数据添加到 namespace 的二级缓存中。")]),s._v(" "),t("p",[s._v("二级缓存比一级缓存作用域更大，多个 sqlsession 可以共用二级缓存，即，二级缓存是跨 sqlsession 的。")]),s._v(" "),t("blockquote",[t("p",[t("small",[s._v("例如，关闭一个 sqlsession 之后，打开一个新的 sqlsession，执行同一条 sql 语句，会利用上一次的缓存数据。")])])]),s._v(" "),t("p",[s._v("mybatis "),t("strong",[s._v("默认没有开启二级缓存")]),s._v(" ，需要在配置中进行配置才能使用。打开二级缓存分为三步：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("打开二级缓存总开关")])]),s._v(" "),t("li",[t("p",[s._v("打开需要使用二级缓存的 mapper 的开关。")])]),s._v(" "),t("li",[t("p",[s._v("POJO 序列化")])])]),s._v(" "),t("h3",{attrs:{id:"打开二级缓存总开关"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#打开二级缓存总开关"}},[s._v("#")]),s._v(" 打开二级缓存总开关")]),s._v(" "),t("p",[s._v("打开总开关，只需要在 mybatis 总配置文件中加入一行设置")]),s._v(" "),t("div",{staticClass:"language-xml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("settings")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!--开启二级缓存--\x3e")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("setting")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("cacheEnabled"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("value")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("settings")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),t("h3",{attrs:{id:"打开需要使用二级缓存的-mapper-的开关。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#打开需要使用二级缓存的-mapper-的开关。"}},[s._v("#")]),s._v(" 打开需要使用二级缓存的 mapper 的开关。")]),s._v(" "),t("p",[s._v("在需要开启二级缓存的 "),t("em",[t("strong",[s._v("mapper.xml")])]),s._v(" 中加入 caceh 标签")]),s._v(" "),t("div",{staticClass:"language-xml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("cache")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v("\n")])])]),t("h3",{attrs:{id:"pojo-序列化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pojo-序列化"}},[s._v("#")]),s._v(" POJO 序列化")]),s._v(" "),t("p",[s._v("让需要使用二级缓存的 POJO 类实现 Serializable 接口，如")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Department")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Serializable")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("通过之前三步操作就可以使用二级缓存了。")])])}),[],!1,null,null,null);a.default=n.exports}}]);